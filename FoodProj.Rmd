---
title: "440-FinalProj"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
https://www.kaggle.com/datasets/mariaren/covid19-healthy-diet-dataset?resource=download&select=Food_Supply_Quantity_kg_Data.csv
 
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7306972/ 

https://www.hsph.harvard.edu/nutritionsource/nutrition-and-immunity/

https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7919160/

https://www.cdc.gov/coronavirus/2019-ncov/need-extra-precautions/people-with-medical-conditions.html 

https://www.cdc.gov/healthyweight/index.html
```{r}
library(tidyverse)
library(betareg)
```

## Introduction

When the novel coronavirus (COVID-19) pandemic spread through the world in late 2019 and 2020, it caused quarantines resulting in worldwide shutdowns of travel and commerce. Despite many limitations on travel, mask mandates, testing protocols, and social distancing requirements, the disease still caused shortages in hospital resources, including PPE, ventilators, and ICU beds. For example, the pandemic has caused up to 300,000 people in the US needing ICU beds simultaneously, while estimates for total ICU beds in the US are around 100,000. 

The pervasiveness of the disease begs the question whether or not individual behaviors and life choices can decrease one's risk of either contracting or dying from the disease. Obesity, for example, is associated with higher rates of severe illness from COVID-19 (https://www.cdc.gov/coronavirus/2019-ncov/need-extra-precautions/people-with-medical-conditions.html). While obesity is influenced by genetic and environmental factors, it can be controlled by lifestyle choices such as exercise and healthy eating. 

On the topic of healthy eating, Harvard T.H. Chan School of Public Health says that a "balanced diet consisting of a range of vitamins and minerals, combined with healthy lifestyle factors... most effectively primes the body to fight infection and disease." As a result, I am interested in whether or not dietary choices can effect rates of contracting COVID-19 or rates of serious illness/death.

My data is called the COVID-19 Healthy Diet Dataset and comes from Kaggle courtesy of user Maria Ren, and was last updated the week of 02/06/2021, giving plenty of data from the COVID-19 pandemic to work with. There are 4 datasets provided, each of which contains information about a part of people's diet. One contains information about people's consumption of fat, another for protein, another for overall food intake (in kg), and another for overall food intake (in kcal). Each dataset has 170 rows (countries) and the same 32 columns. There is a column for country name and many different columns representing food groups that contain information about what percentage of people's diet (in the category defined by the dataset it comes from) that each food group takes up. For example, the animal fats column in the Fats dataset represents the percentage of a countries total fat intake that is comprised of animal fats. Meanwhile, the column animal fats in the Overall Food Intake (kg) dataset will represent the percentage of countries total food intake in kg that is comprised of animal fats. In addition, there are columns (I will refer to these following columns as demographic/outcome information) for obesity rate, undernourished rate, confirmed COVID-19 case rate, COVID-19 death rate, active COVID-19 case rate, and total population. All of the rates are calculated as percentage of total population, for example, confirmed COVID-19 case rate in a country is the percent of people in that country that have COVID-19. The demographic/outcome information is identical for all 4 datasets. 

The 4 datasets were combined by joining them together on the country field (all the countries in the 4 sets are the same), and deleting the duplicate demographic/outcome information.



https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8954090/



```{r}
fat <- read.csv("Fat_Supply_Quantity_Data.csv")
food_kg <- read.csv("Food_Supply_Quantity_kg_Data.csv")
food_cal <- read.csv("Food_Supply_kcal_Data.csv")
protein <- read.csv("Protein_Supply_Quantity_Data.csv")
GDP <- read.csv("GDP_Per_Capita.csv")
```
```{r}
GDP <- GDP %>% 
  mutate(Country = Ã¯..Country.Name) %>% 
  mutate(GDP_per_cap = X2020) %>% 
  select(Country, GDP_per_cap)
GDP
```

```{r}

fat <- fat %>% 
  select(-c(Obesity, Undernourished, Confirmed, Deaths, Recovered, Active, Population, Unit..all.except.Population.))
names <- colnames(fat)
for (i in seq(length(names)-1)) {
  names[i+1] <- paste0(names[i+1], "_fat")
}
colnames(fat) <- names

food_kg <- food_kg %>% 
  select(-c(Obesity, Undernourished, Confirmed, Deaths, Recovered, Active, Population, Unit..all.except.Population.))
names <- colnames(food_kg)
for (i in seq(length(names)-1)) {
  names[i+1] <- paste0(names[i+1], "_food_kg")
}
colnames(food_kg) <- names

protein <- protein %>% 
  select(-c(Obesity, Undernourished, Confirmed, Deaths, Recovered, Active, Population, Unit..all.except.Population.))
names <- colnames(protein)
for (i in seq(length(names)-1)) {
  names[i+1] <- paste0(names[i+1], "_protein")
}
colnames(protein) <- names

merged <- merge(fat, food_kg, by = "Country", all = TRUE)

merged <- merge(merged, protein, by = "Country", all = TRUE)

merged <- merge(merged, food_cal, by = "Country", all = TRUE)

print(merged)

merged <- merged %>%
  mutate(Animal_no_seafood_fat = Animal.Products_fat - Fish..Seafood_fat) %>%
  mutate(Vegetal_no_oil_fat = Vegetal.Products_fat - Vegetable.Oils_fat) %>%
  mutate(Animal_no_seafood_protein = Animal.Products_protein - Fish..Seafood_fat) %>%
  mutate(Vegetal_no_oil_protein = Vegetal.Products_protein - Vegetable.Oils_protein)


print(merged$Undernourished)


```

### EDA

```{r}
ggplot(data = merged, aes(x = Animal.Products_fat, y = Deaths, color = Obesity)) + geom_point() + scale_color_gradient(low="black", high="yellow") + labs()

ggplot(data = merged, aes(x = Animal.fats, y = Deaths, color = Obesity)) + geom_point() + scale_color_gradient(low="black", high="yellow") + labs()

ggplot(data = merged, aes(x = Fruits...Excluding.Wine, y = Deaths, color = Obesity)) + geom_point() + scale_color_gradient(low="black", high="yellow") + labs()
```

## Methodology

```{r}
merged %>% 
  filter_all(any_vars(is.na(.))) %>% 
  select(Country, Obesity, Undernourished, Confirmed, Deaths, Recovered, Active)
##Canada 45954
##Chile 9622
rownames(merged) <- merged$Country
CanadaActive <- 45954/merged["Canada",]$Population
ChileActive <- 9622/merged["Chile",]$Population
print(CanadaActive)
print(ChileActive)
merged["Canada", "Active"]<- CanadaActive
merged["Chile", "Active"] <- ChileActive

merged %>% 
  filter(Active==0|Confirmed==0|Deaths==0) %>% 
  select(Country, Active, Confirmed, Deaths)


merged <- merged %>% 
  select(Country, Animal_no_seafood_fat, Fish..Seafood_fat, Vegetal_no_oil_fat, Vegetable.Oils_fat, Animal_no_seafood_protein, Fish..Seafood_protein, Vegetal_no_oil_protein, Vegetable.Oils_protein, Alcoholic.Beverages, Animal.fats, Cereals...Excluding.Beer, Eggs, Fish..Seafood, Meat,  Fruits...Excluding.Wine, Milk...Excluding.Butter, Miscellaneous, Offals, Oilcrops, Pulses, Spices, Starchy.Roots, Stimulants, Sugar...Sweeteners, Treenuts, Vegetable.Oils, Vegetables, Obesity, Deaths, Confirmed, Active, Population)

merged_nas <- merged %>% 
  filter_all(any_vars(is.na(.)))
merged <- setdiff(merged, merged_nas)
merged
```
```{r}
merged_final <- merge(merged, GDP, all.x=TRUE)
merged_final %>% 
  select(GDP_per_cap)
rownames(merged_final) <- merged_final$Country

merged_final["Bahamas", "GDP_per_cap"]<- 24665.10
merged_final["Congo", "GDP_per_cap"]<- 543.95
merged_final["Egypt", "GDP_per_cap"]<- 3569.21
merged_final["Gambia", "GDP_per_cap"]<- 757.41
merged_final["Iran (Islamic Republic of)", "GDP_per_cap"]<- 2756.75
merged_final["Korea, South", "GDP_per_cap"]<- 31597.50
merged_final["Kyrgyzstan", "GDP_per_cap"]<- 1182.52
merged_final["Lao People's Democratic Republic", "GDP_per_cap"]<- 2551.33
merged_final["Republic of Moldova", "GDP_per_cap"]<- 5314.53  
merged_final["Saint Kitts and Nevis", "GDP_per_cap"]<-18230.13   
merged_final["Saint Lucia", "GDP_per_cap"]<-9571.00
merged_final["Saint Vincent and the Grenadines", "GDP_per_cap"]<-7996.61 
merged_final["Slovakia", "GDP_per_cap"]<- 21087.85
merged_final["Turkey", "GDP_per_cap"]<-9586.61   
merged_final["United Republic of Tanzania", "GDP_per_cap"]<-1135.54   
merged_final["United States of America", "GDP_per_cap"]<- 63027.68  
merged_final["Venezuela (Bolivarian Republic of)", "GDP_per_cap"]<- 4500.00  
merged_final["Yemen", "GDP_per_cap"] <- 690.76
  
  
  
merged_final %>% 
  filter_all(any_vars(is.na(.))) %>% 
  select(Country, GDP_per_cap)
merged_final %>% 
  select(GDP_per_cap)
```




```{r}
# library(mice)
# merged_test <- merged %>% 
#   select(-c(Alcoholic.Beverages_fat, Aquatic.Products..Other_fat, Sugar.Crops_fat, Sugar...Sweeteners_fat, Aquatic.Products..Other_food_kg, Sugar.Crops_food_kg, Aquatic.Products..Other_protein, Sugar.Crops_protein, Sugar...Sweeteners_protein, Aquatic.Products..Other, Sugar.Crops, Unit..all.except.Population., Obesity))


# 
# imputed_Data <- mice(merged, m=5, maxit = 50, method = 'pmm', seed = 500)
# summary(imputed_Data)
  
```

### Model formulation/selection

I decided to concentrate on two response variables in particular, rates of COVID-19 related deaths and confirmed cases. I will fit two models, one for each response variable. I am mostly interested in the relationship between each of the four predictor variables vegetable, fruit, meat, and animal fat consumption as a percentage of total food consumed (in kcal) and the response variables. These variables will go into my model. I also decided to control for the consumption of other dietary food groups as a percentage of total food consumed (in kcal). As a result, I also added variables for alcoholic beverages, cereals (wheat, rice, and other grain products), eggs, fish and seafood, milk, offals, oilcrops (including coconuts, peanuts, rapeseed, mustardseed, sunflower seeds, soybeans, etc.), pulses (legumes), spices, starchy root vegetables, spices, stimulants (including coffee, tea, and cacao products), tree nuts, vegetable oils, sugar and sweeteners, and finally miscellaneous, all representing percentage of total food consumed in kcal in order to control for these effects. 

In addition, given that there was data available for the percentage of total protein and fats each of the food groups took up, I decided to also control for these. However, in the interest of being parsimonious, I used variables representing larger food groups to control for them. I added in variables for percentage of total fat intake from animal products (not including seafood), seafood, vegetal products (any plant related products not including oils), and vegetable oils. Similar variables were added to the model but instead of fat, they measured percentage of total protein intake. 

I also added in variables for obesity rate and population to control for these factors as well. I decided to not to include undernourished rate. This was because the data for undernourished rate was recorded in a strange way where anything under 2.5% was recorded in the same way. I did not see a principled way to create numerical values for this data, and using another source of data was not feasible because I was not sure exactly where and how the undernourished rate was defined in the original data set. As a result, I decided to omit the undernourished rate from the model. Lastly, from a quick initial survey, it seems that how affluent a country is may effect COVID-19 case rates, deaths, etc. As a result, I downloaded the 2020 GDP per capita for all countries, and merged it into my dataset using the country name. I went through and cleaned it up and hand inputted a few data points due to certain countries being named slightly differently. 

### Missing Data


After subsetting the data for only predictors we are interested in, 7 of the 170 countries in the dataset contain missing values. All missing values occur in either the variables for rates of obesity,  confirmed cases and deaths. Missing data for a country in the confirmed cases variable was always accompanied with a missing deaths variable. Generally speaking, most countries with missing values are either countries with very small populations or are special cases such as Taiwan or North Korea. I assume this data is MAR since it seems like the missing values are mostly explained by something observed in the data (population). Unfortunately, MICE imputation does not work due to singular values occurring during imputation, even when experimenting with taking out certain problematic columns. In addition, most of the missing data comes in the response variables of confirmed cases and deaths anyway, and imputing response variables does not make much sense. As a result, I will drop these 7 observations with missing values. 

In addition, I will drop 8 additional observations that have values of 0 for deaths. This is because I think that it is unfeasible to have 0 deaths from COVID-19 by February 2021, and also because beta regression models must have response variables between 0 and 1 non-inclusive. I will keep in mind that dropping these 15 total observations will bias the results. 

```{r}
merged_modeling <- merged_final %>% 
  mutate(Deaths = Deaths/100) %>% 
  mutate(Confirmed = Confirmed/100)

nrow(merged_modeling)
merged_modeling <- merged_modeling %>% 
  filter(Deaths>0 & Deaths<1)
nrow(merged_modeling)


model1 <- betareg(Deaths~ Animal_no_seafood_fat+ Fish..Seafood_fat + Vegetal_no_oil_fat + Vegetable.Oils_fat + Animal_no_seafood_protein+ Fish..Seafood_protein + Vegetal_no_oil_protein + Vegetable.Oils_protein + Alcoholic.Beverages + Animal.fats  + Cereals...Excluding.Beer + Eggs + Fish..Seafood + Meat +  Fruits...Excluding.Wine + Milk...Excluding.Butter + Miscellaneous + Offals + Oilcrops + Pulses + Spices + Starchy.Roots + Stimulants + Sugar...Sweeteners + Treenuts + Vegetable.Oils + Vegetables + Obesity + GDP_per_cap + Population, data = merged_modeling)
summary(model1)





```
```{r}
model2 <- betareg(Confirmed~ Animal_no_seafood_fat+ Fish..Seafood_fat + Vegetal_no_oil_fat + Vegetable.Oils_fat + Animal_no_seafood_protein+ Fish..Seafood_protein + Vegetal_no_oil_protein + Vegetable.Oils_protein + Alcoholic.Beverages + Animal.fats  + Cereals...Excluding.Beer + Eggs + Fish..Seafood + Meat +  Fruits...Excluding.Wine + Milk...Excluding.Butter + Miscellaneous + Offals + Oilcrops + Pulses + Spices + Starchy.Roots + Stimulants + Sugar...Sweeteners + Treenuts + Vegetable.Oils + Vegetables + Obesity + GDP_per_cap + Population, data = merged_modeling)
summary(model2)
```
```{r}
model3 <- betareg(Deaths~ Obesity, data = merged_modeling)
summary(model3)
```


The first model has death rates as the response variable, and the second model has confirmed case rates as the response. Otherwise, the formulations are the same.  Some of the main parts of diet I was focused on was the percentage of total diet (in kcal) taken up by animal fats, fruits, and vegetables. For percentage of total diet taken up by animal fats, the coefficient from the model was 0.179. This means that holding other predictors constant, for every one unit increase in percentage animal fats take up of a country's diet, we expect to see a 0.179 increase in the logit of the deaths due to COVID-19 in that country as a proportion of total population with a 95% confidence interval of [1.269, -0.911]. Holding all other predictors constant, for every one unit increase in percentage of a country's total diet taken up by fruits, we expect to see a 0.295 increase in the logit of death rate with a 95% confidence interval of [1.389, -0.799]. Holding all other predictors constant, for every one unit increase in the percentage of a country's total diet taken up by vegetables, we expect to see a 0.190 increase in the logit of death rate with a 95% confidence interval from [1.298, -0.918]. 

For the second model modeling confirmed cases as a proportion of population, 







